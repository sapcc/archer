swagger: "2.0"
info:
  version: "1.2.0"
  title: "üèπ Archer"
  contact:
    name: SAP SE / Converged Cloud
    url: https://sap.com
  license:
    name: "Apache 2.0"
    url: "http://www.apache.org/licenses/LICENSE-2.0.html"
  x-logo:
    url: "https://avatars.githubusercontent.com/u/4242847"
    backgroundColor: "#FFFFFF"
    altText: "Archer logo"
  description: |
    Archer is an API service that can privatly connect services from one private [OpenStack Network](https://docs.openstack.org/neutron/latest/admin/intro-os-networking.html) to another. Consumers can select a *service* from a service catalog and **inject** it, which means making this *service* available via a private ip address.
    
    Archer implements an *OpenStack* like API and integrates with *OpenStack Keystone* and *OpenStack Neutron*.
    
    ### Features
    * Multi-tenant capable via OpenStack Identity service
    * OpenStack `policy.json` access policy support
    * Prometheus Exporter
    * Rate limiting
    
    ### Supported Backends
    * F5 BigIP
    
    ### Requirements
    * PostgreSQL Database
    
    ### API
    The **Archer API** uses the OpenStack Identity service as the default authentication service. When Keystone is enabled, users that submit requests to the OpenStack Networking service must provide an authentication token in `X-Auth-Token` request header. 
    You obtain the token by authenticating to the Keystone endpoint.

    When Keystone is enabled, the `project_id` attribute is not required in create requests because the project ID is derived from the authentication token.
externalDocs:
  description: GitHub
  url: https://github.com/sapcc/archer
basePath: "/v1"
consumes:
- application/json
produces:
- application/json
tags:
- name: Service
  description: |
    ### Services
    Services are for publishing TCP/UDP services using internal IP addresses in your private network.
- name: Inject
  description: |
    ### Injections
    Injections are for accessing existing Services using internal IP addresses in your private network.
- name: RBAC
  description: |
    ### RBAC Policies
    RBAC Policies are used to provide service visibility to specific project or domains.
- name: Quota
  description: |
    ### Quota Operations
    Administrative API for listing and setting quotas for services and injections.
schemes:
- "https"
- "http"
security:
- "X-Auth-Token": []
securityDefinitions:
  "X-Auth-Token":
    type: "apiKey"
    description: |
      The **Archer API** uses the OpenStack Identity service as the default authentication service. When Keystone is enabled, users that submit requests to the OpenStack Networking service must provide an authentication token in `X-Auth-Token` request header. 
      You obtain the token by authenticating to the Keystone endpoint.
    name: "X-Auth-Token"
    in: "header"
paths:
  /service:
    get:
      tags:
      - Service
      summary: List services
      responses:
        200:
          description: An array of services.
          schema:
            type: array
            items:
              allOf:
              - $ref: "#/definitions/Service"
              - $ref: "#/definitions/Project"
    post:
      tags:
      - Service
      summary: Add a new service to the catalog
      parameters:
      - in: body
        name: body
        description: Service object that needs to be added to the catalog
        required: true
        schema:
          allOf:
          - $ref: "#/definitions/Service"
          - $ref: "#/definitions/Project"
      responses:
        200:
          description: Service
          schema:
            allOf:
            - $ref: "#/definitions/Service"
            - $ref: "#/definitions/Project"
        400:
          description: Validation Error
  /service/{service_id}:
    parameters:
    - in: path
      name: service_id
      required: true
      type: string
      format: uuid
      description: The UUID of the service
    get:
      tags:
      - Service
      summary: Show details of an service
      responses:
        200:
          description: Service
          schema:
            allOf:
            - $ref: "#/definitions/Service"
            - $ref: "#/definitions/Project"
        400:
          description: Validation Error
        404:
          description: Not Found
    put:
      tags:
      - Service
      summary: Update an existing service
      parameters:
      - in: body
        name: body
        description: Service object that needs to be updated
        required: true
        schema:
          allOf:
          - $ref: "#/definitions/Service"
          - $ref: "#/definitions/Project"
      responses:
        200:
          description: Service
          schema:
            allOf:
            - $ref: "#/definitions/Service"
            - $ref: "#/definitions/Project"
        400:
          description: Validation Error
        404:
          description: Not Found
    delete:
      tags:
      - Service
      summary: Remove service from catalog
      description: |
        Deletes this service. There **must** be no active injections for the service for successfully deleting the service. 
        Active injections can be rejected by the service owner via the `/service/{service_id}/reject_consumers` API.
      responses:
        204:
          description: Resource successfully deleted.
        404:
          description: Not Found
        409:
          description: In use.
  /service/{service_id}/consumers:
    parameters:
    - in: path
      name: service_id
      required: true
      type: string
      format: uuid
      description: The UUID of the service
    get:
      tags:
      - Service
      summary: List service injections consumers
      description: |
        Provides a list of service consumers (injections).
        Status can be one of
        * `ACTIVE`
        * `PENDING`
        * `REJECTED`
        
        This list can be used to accept or reject requests, or disable active injections. 
        Rejected injections will be cleaned up after a specific time.
      responses:
        200:
          description: An array of service injections consumers.
          schema:
            type: array
            items:
              allOf:
              - $ref: "#/definitions/InjectionConsumer"
              - $ref: "#/definitions/Project"
        404:
          description: Not Found
  /service/{service_id}/accept_consumers:
    parameters:
    - in: path
      name: service_id
      required: true
      type: string
      format: uuid
      description: The UUID of the service
    put:
      summary: Accept consumer injections
      description: |
        Specify a list of consumers (`consumer_ids` and/or `project_ids`) whose injections should be accepted.
        Existing active injections will be untouched.
        Rejected injection will be accepted.
        Pending injections will be accepted.
      tags:
      - Service
      parameters:
      - in: body
        name: body
        description: Service object that needs to be updated
        required: true
        schema:
          $ref: "#/definitions/InjectionConsumerList"
      responses:
        204:
          description: Ok
        400:
          description: Validation Error
        404:
          description: Not Found
  /service/{service_id}/reject_consumers:
    parameters:
    - in: path
      name: service_id
      required: true
      type: string
      format: uuid
      description: The UUID of the service
    put:
      summary: Reject consumer injections
      description: |
        Specify a list of consumers (`consumer_ids` and/or `project_ids`) whose injections should be rejected.
        Existing active injections will be closed/disabled.
        Rejected injections will be untouched.
        Pending injections will be declined.
      tags:
      - Service
      parameters:
      - in: body
        name: body
        description: Service object that needs to be updated
        required: true
        schema:
          $ref: "#/definitions/InjectionConsumerList"
      responses:
        204:
          description: Ok
        400:
          description: Validation Error
        404:
          description: Not Found

  /inject:
    get:
      tags:
      - Inject
      summary: List existing service injections
      responses:
        200:
          description: An array of injections.
          schema:
            type: array
            items:
              allOf:
              - $ref: "#/definitions/Injection"
              - $ref: "#/definitions/Project"
    post:
      tags:
      - Inject
      summary: Inject a service into a target network.
      parameters:
      - in: body
        name: body
        description: Service and target network to inject. Only one of `target_network`, `target_subnet` or `target_port` must be specified.
        required: true
        schema:
          allOf:
          - $ref: "#/definitions/Injection"
          - $ref: "#/definitions/Project"
      responses:
        200:
          description: Injection
          schema:
            allOf:
            - $ref: "#/definitions/Injection"
            - $ref: "#/definitions/Project"
        400:
          description: Validation Error
  /inject/{injection_id}:
    parameters:
    - in: path
      name: injection_id
      required: true
      type: string
      format: uuid
      description: The UUID of the injection
    get:
      tags:
      - Inject
      summary: Show existing service injection.
      responses:
        200:
          description: An injection detail.
          schema:
            allOf:
            - $ref: "#/definitions/Injection"
            - $ref: "#/definitions/Project"
        404:
          description: Not Found
    delete:
      tags:
      - Inject
      summary: Remove injected service
      responses:
        204:
          description: Resource successfully deleted.
        404:
          description: Not Found
  /rbac-policies:
    get:
      tags:
        - RBAC
      summary: List RBAC policies.
      responses:
        200:
          description: A JSON array of rbac policies
          schema:
            type: array
            items:
              allOf:
              - $ref: "#/definitions/RBACPolicy"
              - $ref: '#/definitions/RBACPolicyServiceID'
              - $ref: "#/definitions/Project"
        default:
          description: Unexpected Error
    post:
      tags:
      - RBAC
      summary: Create RBAC policy.
      parameters:
      - in: body
        name: body
        description: Service and target network to inject.
        required: true
        schema:
          allOf:
          - $ref: "#/definitions/RBACPolicy"
          - $ref: '#/definitions/RBACPolicyServiceID'
          - $ref: "#/definitions/Project"
      responses:
        200:
          description: RBAC policy
          schema:
            allOf:
            - $ref: '#/definitions/RBACPolicy'
            - $ref: '#/definitions/RBACPolicyServiceID'
            - $ref: "#/definitions/Project"
        400:
          description: Validation Error
        409:
          description: Exists
  /rbac-policies/{rbac_policy_id}:
    parameters:
    - in: path
      name: rbac_policy_id
      required: true
      type: string
      format: uuid
      description: The UUID of the RBAC policy.
    get:
      tags:
      - RBAC
      summary: Show details of an RBAC policy.
      responses:
        200:
          description: RBAC Policy
          schema:
            allOf:
            - $ref: '#/definitions/RBACPolicy'
            - $ref: '#/definitions/RBACPolicyServiceID'
            - $ref: "#/definitions/Project"
        404:
          description: Not Found
    put:
      tags:
      - RBAC
      summary: Update an existing RBAC policy.
      parameters:
      - in: body
        name: body
        description: RBAC policy resource that needs to be updated
        required: true
        schema:
          $ref: "#/definitions/RBACPolicy"
      responses:
        200:
          description: RBAC Policy
          schema:
            allOf:
            - $ref: '#/definitions/RBACPolicy'
            - $ref: "#/definitions/Project"
        400:
          description: Validation Error
        404:
          description: Not Found
    delete:
      tags:
      - RBAC
      summary: Delete RBAC policy.
      responses:
        204:
          description: Resource successfully deleted.
        404:
          description: Not Found
  /quotas:
    parameters:
      - in: query
        name: project_id
        type: string
        description: The ID of the project to query.
        minLength: 32
        maxLength: 32
    get:
      tags:
        - Quota
      summary: List Quotas
      responses:
        200:
          description: A JSON array of quotas
          schema:
            type: object
            properties:
              quotas:
                type: array
                items:
                  allOf:
                    - $ref: '#/definitions/Quota'
                    - $ref: '#/definitions/QuotaUsage'
                    - $ref: '#/definitions/Project'
        404:
          description: Not Found
  /quotas/defaults:
    get:
      tags:
        - Quota
      summary: Show Quota Defaults
      responses:
        200:
          description: Show the quota defaults configured for new projects.
          schema:
            type: object
            properties:
              quota:
                $ref: '#/definitions/Quota'
  /quotas/{project_id}:
    parameters:
      - in: path
        name: project_id
        required: true
        type: string
        description: The ID of the project to query.
    get:
      tags:
        - Quota
      summary: Show Quota detail
      responses:
        200:
          description: Shows the details of a specific monitor.
          schema:
            type: object
            properties:
              quota:
                allOf:
                  - $ref: '#/definitions/Quota'
                  - $ref: '#/definitions/QuotaUsage'
        404:
          description: Not Found
    put:
      tags:
        - Quota
      summary: Update Quota
      parameters:
        - in: body
          name: quota
          required: true
          schema:
            type: object
            required:
              - quota
            properties:
              quota:
                $ref: '#/definitions/Quota'
      responses:
        202:
          description: Updated quota for a project.
          schema:
            type: object
            properties:
              quota:
                $ref: '#/definitions/Quota'
        400:
          description: Validation Error
        404:
          description: Not found
    delete:
      tags:
        - Quota
      summary: Reset all Quota of a project
      responses:
        204:
          description: Resource successfully reseted
        404:
          description: Not Found
definitions:
  Service:
    type: object
    properties:
      id:
        type: string
        format: uuid
        description: The id of the resource.
        readOnly: true
      enabled:
        type: boolean
        description: Enable/Disable this service. Existing injections are not touched by this.
      name:
        type: string
        description: Name of the service.
        example: ExampleService
      description:
        type: string
        description: Description of the service.
        example: An example of an Service.
      ports:
        type: array
        description: Ports exposed by the service.
        example: [80, 443]
        items:
          type: integer
          description: Port of the service.
      network_id:
        type: string
        format: uuid
        description: Network ID of the network that provides this service.
      ip_address:
        type: string
        format: ipv4
        description: IP Address of the providing service.
        example: 1.2.3.4
      status:
        type: string
        description: Status of the service.
        enum:
        - AVAILABLE
        - UNAVAILABLE
        readOnly: true
      require_approval:
        type: boolean
        description: Require explicit project approval for the service owner.
        default: true
      visibility:
        type: string
        description: Set global visibility of the service. For `private` visibility, RBAC policies can extend the visibility to specific projects.
        default: private
        enum:
        - private
        - public
      availability_zone:
        type: string
        description: Availability zone of this service.
        x-nullable: true
        example: AZ-A
  InjectionConsumer:
    type: object
    properties:
      id:
        type: string
        format: uuid
        description: The ID of the resource.
        readOnly: true
      status:
        type: string
        description: Status of the injection consumer.
        enum:
        - ACTIVE
        - PENDING
        - REJECTED
        readOnly: true
      proxy_protocol:
        type: boolean
        description: Proxy protocol enabled.
        readOnly: true
  InjectionConsumerList:
    type: object
    description: list of consumer ids.
    properties:
      consumer_ids:
        type: array
        items:
          type: string
          format: uuid
          description: The ID of a service injection consumer.
          readOnly: true
      project_ids:
        type: array
        items:
          type: string
          format: uuid
          description: The ID of a project.
          readOnly: true
  Injection:
    type: object
    properties:
      id:
        type: string
        format: uuid
        description: The ID of the resource.
        readOnly: true
      service_id:
        type: string
        format: uuid
        description: The ID of the service.
      service_name:
        type: string
        example: Example Service
        description: The name of the service.
        readOnly: true
      target_network:
        type: string
        format: uuid
        description: Injection network target. One of `target_network`, `target_subnet` or `target_port` must be specified.
      target_subnet:
        type: string
        format: uuid
        description: Injection subnet target. One of `target_network`, `target_subnet` or `target_port` must be specified.
      target_port:
        type: string
        format: uuid
        description: Injection port target. One of `target_network`, `target_subnet` or `target_port` must be specified.
      proxy_protocol:
        type: boolean
        description: Proxy protocol enabled for this injection endpoint.
      status:
        type: string
        description: Status of the injection.
        enum:
        - READY
        - PENDING
        - DISABLED
        readOnly: true
  RBACPolicy:
    required:
      - target_project
    type: object
    properties:
      id:
        type: string
        format: uuid
        description: The ID of the resource.
        readOnly: true
      target_type:
        type: string
        enum:
        - project_id
        - domain_id
      target:
        description: The ID of the project to which the RBAC policy will be enforced.
        type: string
        example: 666da95112694b37b3efb0913de3f499
  RBACPolicyServiceID:
    required:
    - service_id
    type: object
    properties:
      service_id:
        type: string
        format: uuid
        description: The ID of the service resource.
  Quota:
    type: object
    properties:
      service:
        type: integer
        description: The configured service quota limit. A setting of null means it is using the deployment default quota. A setting of -1 means unlimited.
        example: 5
        x-nullable: true
      inject:
        type: integer
        description: The configured inject quota limit. A setting of null means it is using the deployment default quota. A setting of -1 means unlimited.
        example: 5
        x-nullable: true
  Project:
    type: object
    properties:
      project_id:
        type: string
        description: The ID of the project owning this resource.
        example: fa84c217f361441986a220edf9b1e337
        minLength: 32
        maxLength: 32
  QuotaUsage:
    type: object
    properties:
      in_use_service:
        type: integer
        description: The current quota usage of service.
        example: 5
        x-omitempty: false
      in_use_inject:
        type: integer
        description: The current quota usage of inject.
        example: 5
        x-omitempty: false